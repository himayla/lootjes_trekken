<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Lootjes Trekken</title>
</head>
<body>

  <div style="text-align: center;">
    <img
      src="https://images.unsplash.com/photo-1549465220-1a8b9238cd48?auto=format&fit=crop&w=1200&q=80"
      alt="Cadeaus"
      style="max-width: 50%; height: auto; margin: 20px 0;"
    >
  </div>

  <h2>Deelnemers</h2>
  <p>Deelnemer per regel: <strong>Naam | Verjaardag</strong></p>

  <textarea
    id="input"
    rows="8"
    cols="50"
    placeholder="Jan | 12-03-1990
Piet | 05-11-1988"
  ></textarea>

  <button onclick="generate()">Lootjes trekken</button>

  <div id="links"></div>

  <script>
    const IMAGE_URL =
      "https://images.unsplash.com/photo-1549465220-1a8b9238cd48?auto=format&fit=crop&w=1200&q=80";

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Create a recipients list such that no participant gets themselves.
    function createRecipients(participants) {
      const maxAttempts = 10000;

      for (let attempt = 0; attempt < maxAttempts; attempt++) {
        const recipients = shuffle([...participants]);
        const ok = participants.every((p, i) => recipients[i] !== p);

        if (ok) {
          return recipients;
        }
      }

      throw new Error("Kon geen geldige trekking maken. Probeer opnieuw.");
    }

    function parseParticipants(raw) {
      return raw.split("\n").map(line => {
        const parts = line.split("|").map(p => p.trim());

        if (parts.length !== 2) {
          throw new Error("Elke regel moet 'Naam | Verjaardag' bevatten");
        }

        if (!parts[0] || !parts[1]) {
          throw new Error("Naam en verjaardag mogen niet leeg zijn");
        }

        return {
          name: parts[0],
          birthday: parts[1]
        };
      });
    }

    function generate() {
      const raw = document.getElementById("input").value.trim();

      if (!raw) {
        alert("Geen deelnemers ingevuld");
        return;
      }

      let participants;
      try {
        participants = parseParticipants(raw);
      } catch (e) {
        alert(e.message);
        return;
      }

      if (participants.length < 2) {
        alert("Minimaal 2 deelnemers nodig");
        return;
      }

      let recipients;
      try {
        recipients = createRecipients(participants);
      } catch (e) {
        alert(e.message);
        return;
      }

      const linksDiv = document.getElementById("links");
      linksDiv.innerHTML = "<h3>Deel deze links (één per persoon)</h3>";

      for (let i = 0; i < participants.length; i++) {
        const giver = participants[i];
        const receiver = recipients[i];

        const payload = {
          giver: giver.name,
          receiver: receiver.name,
          birthday: receiver.birthday
        };

        const token = btoa(
          unescape(encodeURIComponent(JSON.stringify(payload)))
        );

        const link = `${location.origin}${location.pathname}?d=${token}`;

        const div = document.createElement("div");
        div.innerHTML = `<strong>${giver.name}</strong>: <a href="${link}">${link}</a>`;
        linksDiv.appendChild(div);
      }
    }

    function showDraw() {
      const params = new URLSearchParams(location.search);

      if (!params.has("d")) {
        return;
      }

      try {
        const data = JSON.parse(
          decodeURIComponent(escape(atob(params.get("d"))))
        );

        document.body.innerHTML = `
          <div style="text-align: center;">
            <img
              src="${IMAGE_URL}"
              alt="Cadeaus"
              style="max-width: 50%; height: auto; margin: 20px 0;"
            >
          </div>

          <h1>Hallo ${data.giver}</h1>
          <p>Jij hebt getrokken:</p>
          <h2>${data.receiver}</h2>
          <p>Verjaardag: <strong>${data.birthday}</strong></p>
        `;
      } catch {
        document.body.innerHTML = "<p>Ongeldige link</p>";
      }
    }

    showDraw();
  </script>

</body>
</html>
